# SUMO Infra
This repo has source code for building SUMO infrastructure in AWS including networking, kubernetes clusters and CI/CD

## Kubernetes Clusters
To stand up most of the infra including Kuberenets and Jenkins, see `k8s/README.md`

## SUMO Secrets
Secrets are stored in a private location, but to aid in future discoverability the structure is described here:
- Global secrets in the `services` directory
  - `mig/` contains a agent certificate and key, a CA cert and a mig agent config all given to us by EIS.  The config looks like:
```
[agent]
    isimmortal      = on
    installservice  = on
    discoverpublicip = on
    discoverawsmeta = on
    checkin         = off
    relay           = "amqps://username:password@url:port/path"
    socket          = "127.0.0.1:51664"
    heartbeatfreq   = "30s"
    moduletimeout   = "1200s"
    api             = "https://api.mig.mozilla.org/api/v1/"

[certs]
    ca  = "/etc/mig/ca.crt"
    cert= "/etc/mig/agent.crt"
    key = "/etc/mig/agent.key"

[logging]
    mode    = "stdout" ; stdout | file | syslog
    level   = "info"
```
  - `newrelic/` contains a newrelic kubernets secret manfiest like:
```
apiVersion: v1
kind: Secret
metadata:
  name: newrelic-config
  namespace: newrelic
type: Opaque
data:
  config: <base64 encoded NR api key>
```
- For each cluster, e.g. `us-west-2a`:
  - credentials-ark contains secrets generated by our ark terraform
```
[default]
ark_access_key=
ark_secret_key=
```
  - credentials-block-aws links to a specific Deadman's Snitch URL
    `DMS_URL=https://nosnch.in/unique_path`
  - papertrail.env has papertrail syslog host and a port specific to this cluster
```
export SYSLOG_HOST="logs.papertrailapp.com"
export SYSLOG_PORT="unique_port"
```
